<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard University – Data Pipes Map</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem 1.5rem 2rem 1.5rem;
      background: #f7f7f7;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.2rem;
    }
    #intro {
      max-width: 760px;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    #controls {
      margin: 0.5rem 0 0.75rem 0;
    }
    button {
      margin-right: 0.5rem;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.active {
      background: #333;
      color: white;
      border-color: #333;
    }
    #layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1fr);
      grid-gap: 1rem;
      align-items: flex-start;
    }
    #chart {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
      padding: 0.5rem;
    }
    svg {
      width: 100%;
      height: 600px;
    }
    .link {
      stroke-opacity: 0.7;
    }
    .node-label {
      font-size: 10px;
      pointer-events: none;
    }
    #legend {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
      padding: 0.75rem 0.9rem;
      font-size: 0.85rem;
      line-height: 1.4;
    }
    #legend h2 {
      font-size: 0.95rem;
      margin: 0 0 0.4rem 0;
    }
    .legend-section {
      margin-bottom: 0.55rem;
    }
    .legend-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .legend-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.18rem;
    }
    .legend-row.legend-level {
      cursor: pointer;
    }
    .legend-row.legend-level.active {
      font-weight: 700;
      text-decoration: underline;
    }

    /* Swatches aligned with node shapes */
    .swatch {
      width: 14px;
      height: 14px;
      margin-right: 0.4rem;
      border: 1px solid rgba(0,0,0,0.2);
      flex-shrink: 0;
      border-radius: 3px; /* default: small rounded square */
    }
    /* Circles – users and local services */
    .swatch.people,
    .swatch.service {
      border-radius: 50%;
    }
    /* Rounded rectangles – platforms / systems / analytics / governance */
    .swatch.platform,
    .swatch.system,
    .swatch.analytics,
    .swatch.governance {
      border-radius: 5px;
      width: 18px;
      height: 10px;
    }
    /* Squares – vendors and landlords */
    .swatch.company,
    .swatch.landlord {
      border-radius: 0;
    }
    /* Colours */
    .swatch.people { background: #e15759; }
    .swatch.service { background: #f28e2b; }
    .swatch.platform { background: #4e79a7; }
    .swatch.system { background: #59a14f; }
    .swatch.analytics { background: #af7aa1; }
    .swatch.governance { background: #ff9da7; }
    .swatch.company { background: #9c755f; }
    .swatch.landlord { background: #bab0ab; }

    .legend-edge {
      display: flex;
      align-items: center;
      margin-bottom: 0.18rem;
    }
    .legend-edge svg {
      width: 42px;
      height: 10px;
      margin-right: 0.4rem;
      flex-shrink: 0;
    }
    .legend-note {
      font-size: 0.78rem;
      color: #555;
      margin-top: 0.35rem;
    }
    .node.selected circle,
    .node.selected rect {
      stroke: #000;
      stroke-width: 2px;
    }
  </style>
</head>
<body>
  <h1>Dashboard University – Data Pipes</h1>
  <p id="intro">
    Toggle between the teaching and research stacks. Nodes show people, platforms, vendors and landlords;
    solid lines show data and metric flows, dashed lines show ownership and governance relations.
    Hover to see what is being extracted or connected. Click a node-type in the controls to pull that function into focus,
    and click individual nodes to see what they ingest and emit.
  </p>
  <div id="controls">
    <button id="btnTeaching" class="active">Teaching stack</button>
    <button id="btnResearch">Research stack</button>
  </div>

  <div id="layout">
    <div id="chart">
      <svg></svg>
    </div>
    <aside id="legend">
      <h2>Controls</h2>

      <div class="legend-section">
        <!-- interactive level filters, no heading text -->
        <div class="legend-row legend-level" data-level="people"><span class="swatch people"></span> People and practitioners</div>
        <div class="legend-row legend-level" data-level="service"><span class="swatch service"></span> Local services and support</div>
        <div class="legend-row legend-level" data-level="platform"><span class="swatch platform"></span> Platforms and tools</div>
        <div class="legend-row legend-level" data-level="system"><span class="swatch system"></span> Core systems of record</div>
        <div class="legend-row legend-level" data-level="analytics"><span class="swatch analytics"></span> Analytics and dashboards</div>
        <div class="legend-row legend-level" data-level="governance"><span class="swatch governance"></span> Governance and KPIs</div>
        <div class="legend-row legend-level" data-level="company"><span class="swatch company"></span> Vendor companies</div>
        <div class="legend-row legend-level" data-level="landlord"><span class="swatch landlord"></span> Financial landlords / parents</div>
      </div>

      <div class="legend-section">
        <div class="legend-title">Node shapes (function in the stack)</div>
        <div class="legend-row">● Circles – users and local services (people, support)</div>
        <div class="legend-row">▭ Rounded rectangles – institutional software and analytics layers</div>
        <div class="legend-row">■ Squares – owners and financial landlords</div>
      </div>

      <div class="legend-section">
        <div class="legend-title">Line styles (how they relate)</div>

        <div class="legend-edge">
          <svg>
            <line x1="2" y1="5" x2="40" y2="5" stroke="#333" stroke-width="1.5" />
          </svg>
          Data / metric flows
        </div>
        <div class="legend-edge">
          <svg>
            <line x1="2" y1="5" x2="40" y2="5" stroke="#999" stroke-width="1.5" stroke-dasharray="4 4" />
          </svg>
          Ownership (platform → vendor → landlord)
        </div>
        <div class="legend-edge">
          <svg>
            <line x1="2" y1="5" x2="40" y2="5" stroke="#666" stroke-width="1.5" stroke-dasharray="4 4" />
          </svg>
          Governance pressure (KPIs, strategy, workload)
        </div>
      </div>

      <div class="legend-section">
        <div class="legend-title">Vertical bands</div>
        <div class="legend-row">Top: corporate owners, landlords, governance nodes</div>
        <div class="legend-row">Middle: software and analytics layer</div>
        <div class="legend-row">Bottom: people, services and lived practice</div>
      </div>

      <div class="legend-section">
        <div class="legend-title">Node details</div>
        <div id="details-content">
          Click a node to see what data flows in and out of it.
        </div>
      </div>

      <div class="legend-note">
        Edge tooltips summarise the main kinds of data or metrics being extracted at each step.
        Use the controls to pivot the layout, then click individual nodes to inspect their local data ecology.
      </div>
    </aside>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const width = 900;
    const height = 600;

    const yForBand = {
      bottom: height * 0.75,
      middle: height * 0.5,
      top: height * 0.25
    };

    const levelColor = d => {
      switch (d.level) {
        case "people": return "#e15759";
        case "service": return "#f28e2b";
        case "platform": return "#4e79a7";
        case "system": return "#59a14f";
        case "analytics": return "#af7aa1";
        case "governance": return "#ff9da7";
        case "company": return "#9c755f";
        case "landlord": return "#bab0ab";
        default: return "#888";
      }
    };

    let currentStack = "teaching";
    let focusLevel = null;
    let selectedNode = null;

    const svg = d3.select("svg");

    Promise.all([
      d3.csv("nodes.csv"),
      d3.csv("edges.csv")
    ]).then(([nodes, edges]) => {
      drawStack(currentStack);

      d3.select("#btnTeaching").on("click", () => {
        currentStack = "teaching";
        selectedNode = null;
        focusLevel = null;
        d3.selectAll(".legend-level").classed("active", false);
        setActiveButton(currentStack);
        drawStack(currentStack);
      });

      d3.select("#btnResearch").on("click", () => {
        currentStack = "research";
        selectedNode = null;
        focusLevel = null;
        d3.selectAll(".legend-level").classed("active", false);
        setActiveButton(currentStack);
        drawStack(currentStack);
      });

      // Legend click to focus by level
      d3.selectAll(".legend-level").on("click", function() {
        const level = this.getAttribute("data-level");
        if (focusLevel === level) {
          focusLevel = null; // toggle off
          d3.selectAll(".legend-level").classed("active", false);
        } else {
          focusLevel = level;
          d3.selectAll(".legend-level").classed("active", false);
          d3.select(this).classed("active", true);
        }
        drawStack(currentStack);
      });

      function setActiveButton(stack) {
        d3.selectAll("#controls button").classed("active", false);
        if (stack === "teaching") {
          d3.select("#btnTeaching").classed("active", true);
        } else {
          d3.select("#btnResearch").classed("active", true);
        }
      }

      function drawStack(stack) {
        svg.selectAll("*").remove();

        const stackNodes = nodes.filter(d => d.stack === stack);
        const nodeById = new Map(stackNodes.map(d => [d.id, d]));

        const stackEdges = edges
          .filter(e => e.stack === stack && nodeById.has(e.source) && nodeById.has(e.target))
          .map(e => Object.assign({}, e, {
            source: nodeById.get(e.source),
            target: nodeById.get(e.target)
          }));

        const detailsEl = document.getElementById("details-content");

        function updateDetails(nodeDatum) {
          if (!detailsEl) return;

          if (!nodeDatum) {
            detailsEl.innerHTML = "Click a node to see what data flows in and out of it.";
            return;
          }

          const outEdges = stackEdges.filter(e => e.source === nodeDatum && e.type === "flow");
          const inEdges  = stackEdges.filter(e => e.target === nodeDatum && e.type === "flow");

          const safe = str => (str || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");

          let html = "";
          html += `<strong>${safe(nodeDatum.label)}</strong><br>`;
          html += `<span style="font-size:0.8rem;color:#555;">${safe(nodeDatum.level)}, ${safe(stack)} stack</span>`;

          html += "<div style='margin-top:0.4rem;'>";

          if (outEdges.length > 0) {
            html += "<div style='margin-bottom:0.25rem; font-weight:600;'>Outgoing data flows</div><ul style='padding-left:1.1rem; margin-top:0;'>";
            outEdges.forEach(e => {
              html += `<li>→ ${safe(e.target.label)} — <span style="font-size:0.8rem;">${safe(e.label)}</span></li>`;
            });
            html += "</ul>";
          } else {
            html += "<div style='margin-bottom:0.25rem;'>No outgoing data flows recorded in this map.</div>";
          }

          if (inEdges.length > 0) {
            html += "<div style='margin:0.4rem 0 0.25rem 0; font-weight:600;'>Incoming data flows</div><ul style='padding-left:1.1rem; margin-top:0;'>";
            inEdges.forEach(e => {
              html += `<li>← ${safe(e.source.label)} — <span style="font-size:0.8rem;">${safe(e.label)}</span></li>`;
            });
            html += "</ul>";
          }

          html += "</div>";
          detailsEl.innerHTML = html;
        }

        const focusNodes = focusLevel
          ? stackNodes.filter(d => d.level === focusLevel)
          : [];

        const focusTargetX = new Map();
        if (focusNodes.length > 0) {
          focusNodes.forEach((d, i) => {
            const x = width * (i + 1) / (focusNodes.length + 1); // evenly spaced across width
            focusTargetX.set(d.id, x);
          });
        }

        const link = svg.append("g")
          .attr("stroke-linecap", "round")
          .selectAll("line")
          .data(stackEdges)
          .join("line")
          .attr("class", "link")
          .attr("stroke", d => {
            if (d.type === "ownership") return "#999";
            if (d.type === "governance") return "#666";
            return "#333";
          })
          .attr("stroke-dasharray", d => d.type === "flow" ? "0" : "4 4")
          .attr("stroke-width", 1.4);

        link.append("title")
          .text(d => {
            const kind = d.type === "flow" ? "Data / metrics" :
                         d.type === "ownership" ? "Ownership / control" :
                         "Governance pressure";
            return kind + ": " + (d.label || "");
          });

        // Node groups
        const node = svg.append("g")
          .selectAll("g")
          .data(stackNodes)
          .join("g")
          .attr("class", "node");

        // Circles – users and local services
        node.append("circle")
          .filter(d => d.level === "people" || d.level === "service")
          .attr("r", d => d.level === "people" ? 8 : 7)
          .attr("fill", d => levelColor(d))
          .attr("stroke", "#fff")
          .attr("stroke-width", 1.2);

        // Rounded rectangles – institutional software / analytics / governance
        node.append("rect")
          .filter(d => d.level === "platform" || d.level === "system" || d.level === "analytics" || d.level === "governance")
          .attr("x", -12)
          .attr("y", -8)
          .attr("width", 24)
          .attr("height", 16)
          .attr("rx", 5)
          .attr("ry", 5)
          .attr("fill", d => levelColor(d))
          .attr("stroke", "#fff")
          .attr("stroke-width", 1.2);

        // Squares – owners and landlords
        node.append("rect")
          .filter(d => d.level === "company" || d.level === "landlord")
          .attr("x", -9)
          .attr("y", -9)
          .attr("width", 18)
          .attr("height", 18)
          .attr("fill", d => levelColor(d))
          .attr("stroke", "#fff")
          .attr("stroke-width", 1.2);

        node.append("title")
          .text(d => d.label + " (" + d.level + ", " + stack + " stack)");

        // Click to show details and mark selection
        node.on("click", (event, d) => {
          selectedNode = d;
          node.classed("selected", n => n === selectedNode);
          updateDetails(d);
        });

        const label = svg.append("g")
          .selectAll("text")
          .data(stackNodes)
          .join("text")
          .attr("class", "node-label")
          .attr("dy", "0.31em")
          .text(d => d.label);

        const simulation = d3.forceSimulation(stackNodes)
          .force("link", d3.forceLink(stackEdges).id(d => d.id).distance(140))
          .force("charge", d3.forceManyBody().strength(-260))
          .force("x", d3.forceX(d => {
            if (focusLevel && focusTargetX.has(d.id)) {
              return focusTargetX.get(d.id);
            }
            return width / 2;
          }).strength(focusLevel ? 0.35 : 0.06))
          .force("y", d3.forceY(d => {
            if (focusLevel && focusTargetX.has(d.id)) {
              return height * 0.18; // top row for focused level
            }
            return yForBand[d.zlevel] || height / 2;
          }).strength(0.3))
          .on("tick", () => {
            link
              .attr("x1", d => d.source.x)
              .attr("y1", d => d.source.y)
              .attr("x2", d => d.target.x)
              .attr("y2", d => d.target.y);

            node
              .attr("transform", d => "translate(" + d.x + "," + d.y + ")");

            label
              .attr("x", d => d.x + 10)
              .attr("y", d => d.y);
          });

        node.call(d3.drag()
          .on("start", (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on("drag", (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on("end", (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }));

        // Restore selection if still in this stack
        if (selectedNode && stackNodes.includes(selectedNode)) {
          node.classed("selected", n => n === selectedNode);
          updateDetails(selectedNode);
        } else {
          selectedNode = null;
          updateDetails(null);
        }
      }
    });
  </script>
</body>
</html>
